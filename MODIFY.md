#### USER-DEFINED REQUIREMENTS 

Define any additional features, integrations, or behavior modifications

#### USER-DEFINED REQUIREMENTS END

# OpenKBS Framework Technical Guide (For AI Coding Agents)

OpenKBS is claud AI platform designed to build, deploy and integrate AI agents and applications.
This guide provides a brief overview of developing backend and frontend logic for your OpenKBS app/agent.

## Project Structure Overview

A typical OpenKBS project has the following key directories:

*   **`src/`**: Contains your custom source code.
    *   **`Events/`**: Houses backend LLM event handlers.
        *   `actions.js`: Example file commonly used for shared backend logic/tools definitions.
        *   `onRequest.js`: Handles incoming user messages before LLM processing.
        *   `onRequest.json`: NPM dependencies for `onRequest.js`.
        *   `onResponse.js`: Handles LLM responses before sending to the user.
        *   `onResponse.json`: NPM dependencies for `onResponse.js`.
        *   `onPublicAPIRequest.js`: Handles unauthenticated public API calls.
        *   `onPublicAPIRequest.json`: Dependencies for `onPublicAPIRequest.js`.
        *   `onAddMessages.js`: Handles messages added via the `chatAddMessages` API.
        *   `onAddMessages.json`: Dependencies for `onAddMessages.js`.
    *   **`Frontend/`**: Contains frontend customization logic.
        *   `contentRender.js`: Custom UI rendering for chat messages, headers, etc.
        *   `contentRender.json`: NPM dependencies for `contentRender.js`.
*   **`app/`**: Application-level configuration.
    *   `settings.json`: Core application settings (model, vendor, etc.).
    *   `instructions.txt`: Instructions for the LLM.
    *   `icon.png`: Application icon.

#### Backend Handlers
- Files with names starting with "on" (like onRequest.js) are called handler 
- Each handler functions as NodeJS execution entry point executed by the platform upon certain events.

#### onRequest and onResponse Handlers

The core of the OpenKBS backend framework revolves around the `onRequest` and `onResponse` Node.js backend event handlers. 
These handlers act as middleware, intercepting user messages and messages generated by the LLM.

- onRequest handler is invoked every time a user sends a message to the chat. It provides an opportunity to process the user's input, extract commands and perform actions based on the user's message.
- onResponse handler is invoked after the LLM generates a response. It allows processing of the LLM's output, execution of commands based on the LLM's message.

#### NPM Dependencies for Backend Handlers

1. If a file imports an NPM dependency and is then imported by a handler, this dependency must be defined in the handler's corresponding json file
2. Example: If actions.js imports node-fetch and onRequest.js imports actions.js, then node-fetch must be in onRequest.json


## Backend Dependencies

To use external NPM packages in your backend event handlers, you must declare them in the corresponding `.json` file.

**Example: Using https module with an API key**

1. **Declare dependencies** in both `src/Events/onRequest.json` and `src/Events/onResponse.json` (as each handler have separate Node.js build):
    ```json
    {
      "dependencies": {
        "got": "^11.8.5"
      }
    }
    ```

2.  **Implement in any JavaScript file** (actions.js is just an example name):

```javascript
export const getActions = (meta) => {
    return [
        [/\/?getNews\("(.*)"\)/, async (match) => {
            const { body } = await got(`https://newsapi.org/v2/everything?q=${match[1]}&apiKey={{secrets.news_api_key}}`, 
                { responseType: 'json' });
            
            return { result: body.articles, ...meta };
        }],
        // ... other actions
    ];
};
```
    
## Secrets Management
OpenKBS provides a secure way to handle sensitive information using the `{{secrets.your_secret_name}}` syntax.
Never hardcode secrets in the code, if any secrets are provided by the user replace them with placeholders syntax above.
The user will later insert the secrets using the secrets manager

#### LLM Instructions
`app/instructions.txt`
This file contains the instructions for the agent

**Example Instructions:**

```
You are an AI assistant.

You can execute the following commands:

/getNews("query")
Description: """
Get the latest news
"""
```

#### Important Coding guidelines
- axios is available (built-in) in the NodeJS execution env, use it if you need http client
- Organize new features across multiple files (like Events/utils.js) rather than adding everything to actions.js
- Similar for Frontend: keep newly implemented React components outside contentRender.js for maintainability.
- Keep in mind onRenderChatMessage is not a React component but simple JS function
